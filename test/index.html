<html>
  <head>
    <title>neat-js</title>
    <script type="text/javascript" src="../src/neat.js"></script>
  </head>
  <body>
    <h1>neat-js testing</h1>
    <script>
      let test_count    = 0
      let success_count = 0

      const eps = 1e-8

      // Performs a TEST checking if the two provided objects are equal
      function testEquals(result, expected, test_name) {
        ++test_count
        if (result === expected) {
          ++success_count
          return true
        }
        console.error(test_name + ' failed!', 'Expected:', expected, 'But got:', result)
        return false
      }

      // Helper function to test if a Number if within epsilon of another
      Number.prototype.within = function(x) {
        return x - eps <= this && this <= x + eps
      }

      // Performs a TEST checking if the two provided Arrays of Numbers
      // are equal to within epsilon
      function testNumArrayEquals(result, expected, test_name) {
        ++test_count
        if (result.every( (res, i) => res.within(expected[i]) )) {
          ++success_count
          return true
        }
        console.error(test_name + ' failed!', 'Expected:', expected, 'But got:', result)
        return false
      }

      /*
      * ·--------------·
      * | TEST SECTION |
      * ·--------------·
      */

      // TEST RANDOM INT GENERATOR
      function testRandInt() {
        ++test_count

        const randInts1 = []
        for (let i = 0; i < 10; ++i)
          randInts1.push(Math.randInt(10, 20))
        const firstTest = randInts1.every( n => n === Math.floor(n) && 10 <= n && n < 20 )

        const randInts2 = []
        for (let i = 0; i < 10; ++i)
          randInts2.push(Math.randInt(-5, 5))
        const secondTest = randInts2.every( n => n === Math.floor(n) && -5 <= n && n < 5 )

        if (firstTest && secondTest) {
          ++success_count
          return true
        }
        console.error('RANDOM INT GENERATOR failed!', 'Got:', randInts1, randInts2)
        return false
      }
      testRandInt()

      // TEST BASIC GENOME FEED
      const g0 = Genome.basic(2,1)
      g0.links.forEach( link => link.weight = 1 )
      g0.outputs.forEach( output => output.bias = 1 )
      testNumArrayEquals(g0.feed(1, 1), [1/(1 + Math.exp(1))], 'BASIC GENOME FEED')

      // TEST ADD RANDOM NODE
      function testAddRandNode() {
        ++test_count

        let success = [g0.addRandNode(g0.nodeCount)]
        success.push(g0.nodeCount === 4)
        success.push(g0.hidden.length === 1)

        const newNode = g0.hidden[0]
        success.push(newNode.incomingLinks.length === 1)

        const newLinkTo = g0.outputs.find( node =>
          node.incomingLinks.some( link => link.from === newNode )
        )
        success.push(newLinkTo.incomingLinks.length === 3)
        success.push(newLinkTo.incomingLinks.find( link => !link.isEnabled ).from
          === g0.hidden[0].incomingLinks[0].from)
        
        success = success.every( x => x )

        if (success) {
          ++success_count
          return true
        }
        console.error('ADD RANDOM NODE failed!', 'Got:', g0)
        return false
      }
      testAddRandNode()

      /*
      * ·---------------------·
      * | END OF TEST SECTION |
      * ·---------------------·
      */

      console.log(`Passed ${success_count}/${test_count} tests`) 
    </script>
  </body>
</html>